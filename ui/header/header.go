package header

import (
	"fmt"

	"github.com/mrusme/gobbs/config"
	"github.com/mrusme/gobbs/ui/ctx"

	"github.com/charmbracelet/bubbles/spinner"
	tea "github.com/charmbracelet/bubbletea"
	"github.com/charmbracelet/lipgloss"
)

var (
	highlight = lipgloss.AdaptiveColor{Light: "#874BFD", Dark: "#7D56F4"}
	banner    = "[0m[38;2;23;3;3;48;2;15;2;2m‚ñÑ[38;2;248;247;247;48;2;41;22;22m‚ñó[38;2;253;251;254;48;2;163;35;115m‚ññ[38;2;145;5;62;48;2;39;5;6m‚ñé[38;2;49;6;6;48;2;32;4;4m‚ñÑ[38;2;239;236;236;48;2;58;25;25m‚ñó[38;2;251;243;246;48;2;116;5;41m‚ñÖ[38;2;210;60;175;48;2;146;10;54m‚ññ[38;2;184;164;164;48;2;55;8;8m‚ñó[38;2;233;207;225;48;2;74;6;19m‚ñÖ[38;2;244;213;240;48;2;159;7;59m‚ñÖ[38;2;253;244;247;48;2;187;30;92m‚ññ[38;2;230;222;222;48;2;109;19;39m‚ñó[38;2;244;219;239;48;2;123;7;42m‚ñÖ[38;2;237;186;231;48;2;156;7;58m‚ñÖ[38;2;227;161;225;48;2;170;24;92m‚ññ[38;2;212;193;196;48;2;71;6;17m‚ñÖ[38;2;240;198;234;48;2;155;6;58m‚ñÖ[38;2;248;217;234;48;2;153;6;58m‚ñÖ[38;2;240;160;198;48;2;163;6;66m‚ññ[38;2;87;6;25;48;2;46;6;6m‚ñè[38;2;50;10;11;48;2;137;117;117m‚ñâ[38;2;246;235;243;48;2;83;5;26m‚ñÖ[38;2;236;186;232;48;2;153;6;58m‚ñÖ[38;2;242;201;233;48;2;181;50;123m‚îì[38;2;217;168;192;48;2;91;6;28m‚ñÖ[38;2;254;251;252;48;2;185;30;100m‚ññ[38;2;173;8;62;48;2;61;8;10m‚ñé[38;2;210;198;198;48;2;56;15;15m‚ñó[38;2;244;222;240;48;2;92;4;33m‚ñÖ[38;2;175;6;106;48;2;47;4;13m‚ñå[0m\n" +
		"[38;2;44;6;6;48;2;34;4;4m‚ñó[38;2;105;79;79;48;2;247;246;246m‚ñé[38;2;232;183;238;48;2;157;12;140m‚ñç[38;2;69;9;10;48;2;58;8;8m‚ñÑ[38;2;176;147;147;48;2;70;11;11m‚ñó[38;2;214;103;202;48;2;239;232;235m‚ñó[38;2;212;107;203;48;2;255;255;255m‚ñé[38;2;250;240;249;48;2;180;14;105m‚ñè[38;2;104;32;32;48;2;236;225;226m‚ñç[38;2;196;14;160;48;2;247;220;237m‚ñù[38;2;246;238;243;48;2;212;61;115m‚ñù[38;2;254;252;254;48;2;193;27;136m‚ñò[38;2;152;78;93;48;2;251;250;250m‚ñç[38;2;192;15;165;48;2;242;201;231m‚ñù[38;2;235;185;203;48;2;162;23;74m‚ñÇ[38;2;130;20;51;48;2;178;145;145m‚ñâ[38;2;255;255;255;48;2;250;245;248m‚îà[38;2;243;192;220;48;2;177;27;124m‚ñÇ[38;2;181;124;147;48;2;252;249;252m‚ñé[38;2;225;150;223;48;2;147;11;110m‚ñç[38;2;73;10;10;48;2;66;9;9m‚ñÖ[38;2;89;36;36;48;2;239;235;235m‚ñã[38;2;251;242;251;48;2;208;91;207m‚ñä[38;2;252;248;249;48;2;167;19;96m‚ñÇ[38;2;231;13;80;48;2;138;21;59m‚ï¥[38;2;193;157;167;48;2;250;242;248m‚ñè[38;2;251;240;249;48;2;209;76;188m‚ñä[38;2;239;218;222;48;2;179;30;80m‚ñó[38;2;254;254;254;48;2;242;229;237m‚ï¥[38;2;249;236;249;48;2;191;38;198m‚ñã[38;2;150;8;113;48;2;53;6;10m‚ñé[0m\n" +
		"[38;2;47;11;11;48;2;174;157;158m‚ñä[38;2;251;245;252;48;2;212;112;220m‚ñâ[38;2;186;15;167;48;2;115;10;33m‚ñå[38;2;75;10;11;48;2;112;19;33m‚ï¥[38;2;136;88;89;48;2;248;241;246m‚ñò[38;2;189;12;175;48;2;234;171;222m‚ñÅ[38;2;221;119;169;48;2;253;250;251m‚ñè[38;2;252;248;252;48;2;205;52;137m‚ñè[38;2;248;229;244;48;2;152;28;51m‚ñÖ[38;2;188;25;91;48;2;235;168;215m‚ñÜ[38;2;241;234;234;48;2;253;249;252m‚îà[38;2;230;144;204;48;2;187;43;109m‚ñè[38;2;251;249;250;48;2;232;171;226m‚ñâ[38;2;180;27;126;48;2;255;255;255m‚ñá[38;2;149;12;66;48;2;217;109;204m‚ñÜ[38;2;115;24;41;48;2;230;218;218m‚ñå[38;2;195;34;181;48;2;248;228;245m‚ñó[38;2;136;46;72;48;2;248;231;246m‚ññ[38;2;252;244;251;48;2;206;48;170m‚ñç[38;2;183;10;99;48;2;78;9;20m‚ñé[38;2;62;8;9;48;2;71;10;10m‚ñÉ[38;2;115;71;71;48;2;246;244;244m‚ñé[38;2;247;229;248;48;2;183;66;169m‚ñé[38;2;84;10;27;48;2;216;115;211m‚ñÖ[38;2;116;24;64;48;2;226;212;212m‚ñã[38;2;251;242;251;48;2;202;54;184m‚ñã[38;2;185;46;126;48;2;244;239;239m‚ñé[38;2;179;18;156;48;2;239;197;234m‚ñó[38;2;199;86;176;48;2;252;244;251m‚ñé[38;2;230;172;232;48;2;154;11;125m‚ñç[38;2;58;8;8;48;2;45;6;6m‚ñò[0m\n" +
		"[38;2;227;222;222;48;2;39;7;14m‚ñù[38;2;112;10;118;48;2;252;247;253m‚ñÑ[38;2;116;11;115;48;2;251;230;240m‚ñÑ[38;2;103;11;89;48;2;236;173;206m‚ñÑ[38;2;254;253;254;48;2;145;33;138m‚ñò[38;2;73;9;22;48;2;161;11;136m‚ñá[38;2;92;13;60;48;2;235;225;228m‚ñÑ[38;2;118;28;87;48;2;224;115;191m‚ñÜ[38;2;98;14;65;48;2;247;240;245m‚ñÑ[38;2;133;21;119;48;2;250;225;237m‚ñÑ[38;2;109;8;84;48;2;228;161;227m‚ñÑ[38;2;205;186;186;48;2;90;10;46m‚ñù[38;2;122;13;110;48;2;253;249;253m‚ñÑ[38;2;121;12;111;48;2;250;226;237m‚ñÑ[38;2;249;217;231;48;2;135;13;103m‚ñò[38;2;255;255;255;48;2;110;47;76m‚ñù[38;2;233;181;236;48;2;116;8;99m‚ñò[38;2;226;217;217;48;2;54;8;9m‚ñù[38;2;255;255;255;48;2;141;30;142m‚ñò[38;2;108;6;57;48;2;56;6;11m‚ñè[38;2;42;5;6;48;2;50;14;14m‚ï¥[38;2;88;9;86;48;2;252;249;252m‚ñÑ[38;2;179;25;203;48;2;67;6;41m‚ñò[38;2;38;5;5;48;2;56;7;7m‚ñÑ[38;2;255;255;255;48;2;76;28;47m‚ñù[38;2;237;197;240;48;2;117;8;107m‚ñò[38;2;60;7;16;48;2;143;76;100m‚ñá[38;2;55;8;8;48;2;87;17;52m‚ï¥[38;2;93;10;87;48;2;251;244;252m‚ñÑ[38;2;169;14;189;48;2;56;5;33m‚ñò[38;2;21;3;3;48;2;33;4;4m‚ñÑ[0m\n" +
		"   v" + config.VERSION
)

type Model struct {
	ctx     *ctx.Ctx
	spinner spinner.Model
}

func NewModel(c *ctx.Ctx) Model {
	m := Model{
		ctx: c,
	}

	m.spinner = spinner.New()
	m.spinner.Spinner = spinner.Dot
	m.spinner.Style = lipgloss.NewStyle().Foreground(lipgloss.Color("205"))

	return m
}

func (m Model) Init() tea.Cmd {
	return m.spinner.Tick
}

func (m Model) Update(msg tea.Msg) (Model, tea.Cmd) {
	var cmds []tea.Cmd

	if m.ctx.Loading == true {
		cmds = append(cmds, m.spinner.Tick)
	} else {
		return m, nil
	}

	switch msg := msg.(type) {
	case spinner.TickMsg:
		var cmd tea.Cmd
		m.spinner, cmd = m.spinner.Update(msg)
		cmds = append(cmds, cmd)
	}

	return m, tea.Batch(cmds...)
}

func (m Model) View() string {
	var row string
	var spinner string = ""

	selector := lipgloss.NewStyle().
		Foreground(lipgloss.Color("#7fffd4")).
		BorderForeground(lipgloss.Color("#7fffd4")).
		Border(lipgloss.NormalBorder()).
		Padding(0, 1, 0, 1).
		Width(40)

	curSysIdx := m.ctx.GetCurrentSystem()
	var currentSystem string = "All"
	if curSysIdx >= 0 {
		currentSystem = (*m.ctx.Systems[curSysIdx]).Title()
	}

	systemSelector := selector.Render(fmt.Sprintf("‚è∑  %s", currentSystem))
	forumSelector := selector.Render("‚è∑  All")

	selectorColumn := lipgloss.JoinVertical(lipgloss.Center,
		lipgloss.JoinHorizontal(lipgloss.Bottom, "System: \n   "+
			lipgloss.NewStyle().Foreground(m.ctx.Theme.DialogBox.Bottombar.GetForeground()).Render("c-s"),
			systemSelector),
		lipgloss.JoinHorizontal(lipgloss.Bottom, "Forum: \n  "+
			lipgloss.NewStyle().Foreground(m.ctx.Theme.DialogBox.Bottombar.GetForeground()).Render("c-f"),
			forumSelector),
	)

	if m.ctx.Loading == true {
		spinner = m.spinner.View()
	}

	row = lipgloss.JoinHorizontal(lipgloss.Top, banner, "   ", selectorColumn, " ", spinner)

	return row
}
